---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const albums = await getCollection('albums');
export const prerender = true;
---

<Layout title="kvibeshopcl | CatÃ¡logo âœ¨">
  <main class="flex flex-col items-center w-full min-h-screen pt-2 pb-10 px-4 bg-white">

    <div class="w-full max-w-md mb-12">
      <input 
        type="text" 
        id="search-input"
        placeholder="Buscar por grupo o Ã¡lbum..." 
        class="w-full p-4 border-2 border-purple-100 rounded-full focus:border-purple-500 outline-none transition-all shadow-sm text-sm"
      />
    </div>

    <section class="w-full max-w-6xl mx-auto">
      <div id="album-grid" class="grid grid-cols-2 md:grid-cols-4 gap-8">
        {
          albums.map((album) => {
            const { id, data } = album;
            const { title, img, price } = data;

            return (
              /* IMPORTANTE: El data-title permite que el script encuentre el producto */
              <article class="album-card flex flex-col items-center" data-title={title.toLowerCase()}>
                <a href={`/album/${id}`} class="w-full aspect-square overflow-hidden rounded-xl shadow-lg mb-4">
                  <img src={`/${img}`} alt={title} class="w-full h-full object-cover" />
                </a>
                <h2 class="text-xs font-bold uppercase text-purple-900 line-clamp-1">{title}</h2>
                <p class="text-purple-700 font-black">{price}</p>
              </article>
            )
          })
        }
      </div>

      <div id="no-results" class="hidden text-center py-20 text-gray-400 italic">
        No hay resultados para tu bÃºsqueda ðŸ¥²
      </div>
    </section>
  </main>
</Layout>

<script>
  // Esta funciÃ³n se ejecuta CADA VEZ que la pÃ¡gina carga, solucionando el error
  document.addEventListener('astro:page-load', () => {
    const searchInput = document.querySelector('#search-input') as HTMLInputElement;
    const cards = document.querySelectorAll('.album-card');
    const noResults = document.querySelector('#no-results');

    if (searchInput) {
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        let found = false;

        cards.forEach(card => {
          const title = card.getAttribute('data-title') || '';
          if (title.includes(query)) {
            (card as HTMLElement).style.display = 'flex';
            found = true;
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });

        if (found) {
          noResults?.classList.add('hidden');
        } else {
          noResults?.classList.remove('hidden');
        }
      });
    }
  });
</script>

<style>
.logo-small {
    height: 72px; 
    width: auto;  
    object-fit: contain;
    border: 0;
    outline: none;
    user-select: none;
    pointer-events: none;
    transition: none!important; 
  }

  @media (max-width: 768px) {
  .logo-small {
      height: 48px; 
    }
  }
</style>